box: ubuntu
validate:
  steps:
    - script:
        name: create terraform directory and export PATH
        code: |
          mkdir -p $HOME/terraform
          export PATH=$PATH:$HOME/terraform
    - script:
        name: install wget / curl / unzip
        code: |
          apt-get update
          apt-get -y -qq install wget unzip curl
    - script:
        name: download terraform
        code: |
          cd $HOME/terraform
          wget https://releases.hashicorp.com/terraform/0.6.16/terraform_0.6.16_linux_amd64.zip
          unzip terraform_0.6.16_linux_amd64.zip
          rm terraform_0.6.16_linux_amd64.zip
    - script:
        name: run terraform validate
        code: |
          terraform validate

plan:
  steps:
    - script:
        name: set ENV vars
        code: |
          export STATE_STOR_BUCKET=${STATE_STOR_BUCKET:-kodingdev-tf-state}
          export STATE_STOR_BUCKET_REGION=${STATE_STOR_BUCKET_REGION:-us-east-1}
          export STATE_STOR_KEY=${STATE_STOR_KEY:-$WERCKER_APPLICATION_NAME}
    - releasequeue/run-terraform@0.0.17:
        action: plan
        state_stor_bucket: $STATE_STOR_BUCKET
        state_stor_bucket_region: $STATE_STOR_BUCKET_REGION
        state_stor_key: $STATE_STOR_KEY

apply:
  steps:
    - script:
        name: set ENV vars
        code: |
          export STATE_STOR_BUCKET=${STATE_STOR_BUCKET:-kodingdev-tf-state}
          export STATE_STOR_BUCKET_REGION=${STATE_STOR_BUCKET_REGION:-us-east-1}
          export STATE_STOR_KEY=${STATE_STOR_KEY:-$WERCKER_APPLICATION_NAME}
    - releasequeue/run-terraform@0.0.17:
        action: apply
        state_stor_bucket: $STATE_STOR_BUCKET
        state_stor_bucket_region: $STATE_STOR_BUCKET_REGION
        state_stor_key: $STATE_STOR_KEY

deploy:
  steps:
    - add-ssh-key:
        keyname: DEPLOYMENT_KEY
    - script:
        name: create version file
        code: |
          $WERCKER_ROOT/scripts/create_version.sh
    - script:
        name: create temporary tokens
        code: |
          echo $ROLLBAR_TOKEN > ROLLBAR_TOKEN
          echo $PAPERTRAIL_PORT > PAPERTRAIL_PORT
          echo $PAPERTRAIL_TOKEN > PAPERTRAIL_TOKEN
    - script:
        name: zip
        code: |
          cd $WERCKER_ROOT
          zip -q --symlinks -r $(cat $WERCKER_ROOT/ARCHIVE_NAME) . || :
    - koding/eb-deploy@0.31.0:
        access-key: $S3_KEY_ID
        secret-key: $S3_KEY_SECRET
        app-name: koding
        env-name: $EB_ENV_NAME
        version-label: $(cat $WERCKER_ROOT/ARCHIVE_NAME)
        region: $EB_ENV_REGION
        s3-bucket: $S3_EB_DEPLOY-$EB_ENV_REGION
        s3-key: $(cat $WERCKER_ROOT/ARCHIVE_NAME)
